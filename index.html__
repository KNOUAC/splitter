<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNOUAC Book Splitter</title>
    
    <script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ (app.pyì˜ custom_style ì´ì‹) */
        @import url("https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css");

        :root {
            --primary-red: #d9534f;
            --primary-red-hover: #c9302c;
            --primary-blue: #007bff;
            --bg-blue-light: #f0f8ff;
            --success-green: #28a745;
        }

        body {
            font-family: 'Suit', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #333;
            margin: 0;
            padding-top: 80px; /* ìƒë‹¨ë°” ê³µê°„ í™•ë³´ */
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” (Sticky Header) */
        .custom-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: white;
            z-index: 9999;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .knouac-logo {
            font-family: 'Impact', sans-serif;
            font-size: 32px;
            color: #2c3e50;
            letter-spacing: 1px;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            width: 100%;
            max-width: 700px;
            padding: 20px;
            box-sizing: border-box;
        }

        .main-title {
            font-size: 26px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            color: #111;
        }

        .sub-description {
            text-align: center;
            color: #666;
            font-size: 15px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* ì—…ë¡œë“œ ë°•ìŠ¤ */
        .upload-area {
            border: 4px dashed #ccc;
            background-color: #fafafa;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover {
            border-color: var(--primary-blue);
            background-color: var(--bg-blue-light);
        }
        .upload-label {
            font-weight: bold;
            color: #333;
        }
        
        /* ì˜µì…˜ ë° ë²„íŠ¼ ì˜ì—­ */
        .controls-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none; /* íŒŒì¼ ì„ íƒ ì „ì—” ìˆ¨ê¹€ */
        }

        .flex-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-group label {
            margin-right: 15px;
            cursor: pointer;
            font-size: 15px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: white;
        }
        .btn-primary:hover { background-color: var(--primary-red-hover); }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }

        .btn-success {
            background-color: var(--success-green);
            color: white;
            margin-top: 10px;
        }

        /* ì§„í–‰ë¥  í‘œì‹œ */
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: var(--primary-blue);
            transition: width 0.3s;
        }
        .status-text {
            text-align: center;
            font-size: 14px;
            margin-top: 8px;
            color: #666;
        }

        /* ìœ í‹¸ */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="custom-navbar">
        <div class="knouac-logo">KNOUAC</div>
    </div>

    <div class="container">
        <div class="main-title">ì±… ìŠ¤ìº” ì´ë¯¸ì§€ ë°˜ë°˜ ë¶„í• ê¸°</div>
        <div class="sub-description">
            ë‘ ìª½ì„ í•œ íŒì— ìŠ¤ìº”í•œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´<br>
            ë°˜ë°˜ ì˜ë¼ì„œ í•˜ë‚˜ì˜ PDF ë˜ëŠ” ZIP íŒŒì¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
        </div>

        <div class="upload-label" style="text-align: center; margin-bottom: 10px;">
            ì—¬ê¸°ë¥¼ í„°ì¹˜í•´ ì´ë¯¸ì§€ ì„ íƒ (JPG, PNG, HEIC, BMP)
        </div>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <span style="font-size: 40px;">ğŸ“‚</span><br>
            <span id="fileCountText">í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ</span>
            <input type="file" id="fileInput" multiple accept="image/*,.heic" class="hidden">
        </div>

        <div id="controlsBox" class="controls-box">
            <div class="flex-row">
                <div class="checkbox-group">
                    <strong>ì €ì¥ í˜•ì‹:</strong> &nbsp;
                    <label><input type="checkbox" id="chkPdf" checked> PDF</label>
                    <label><input type="checkbox" id="chkZip"> ZIP</label>
                </div>
                <div class="checkbox-group" style="font-size:13px; color:#666;">
                   <label><input type="checkbox" id="chkOcr"> í˜ì´ì§€ ë²ˆí˜¸ ìë™ ì¸ì‹ (ëŠë¦¼)</label>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button id="startBtn" class="btn-primary">âŒ– ë³€í™˜ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <div id="progressContainer" class="progress-container">
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
            <div id="statusText" class="status-text">ì¤€ë¹„ ì¤‘...</div>
        </div>

        <div id="downloadArea" style="margin-top: 20px;"></div>
    </div>

<script>
    // === ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ===
    let selectedFiles = [];
    let processedPages = []; // { name: '10.jpg', blob: Blob, ... }

    // === DOM ìš”ì†Œ ===
    const fileInput = document.getElementById('fileInput');
    const controlsBox = document.getElementById('controlsBox');
    const fileCountText = document.getElementById('fileCountText');
    const startBtn = document.getElementById('startBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');
    const downloadArea = document.getElementById('downloadArea');
    const chkOcr = document.getElementById('chkOcr');

    // === ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            selectedFiles = Array.from(e.target.files);
            fileCountText.innerText = `${selectedFiles.length}ê°œì˜ íŒŒì¼ì´ ì„ íƒë¨`;
            controlsBox.style.display = 'block';
            
            // UI ì´ˆê¸°í™”
            downloadArea.innerHTML = '';
            progressContainer.style.display = 'none';
        }
    });

    startBtn.addEventListener('click', async () => {
        const wantPdf = document.getElementById('chkPdf').checked;
        const wantZip = document.getElementById('chkZip').checked;

        if (!wantPdf && !wantZip) {
            alert('âš ï¸ ì €ì¥í•  í˜•ì‹ì„ ìµœì†Œ í•˜ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš” (PDF ë˜ëŠ” ZIP)');
            return;
        }

        // ë³€í™˜ ì‹œì‘
        startBtn.disabled = true;
        downloadArea.innerHTML = '';
        processedPages = [];
        progressContainer.style.display = 'block';
        
        try {
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                updateProgress(i, selectedFiles.length, `${i + 1}ë²ˆì§¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘... (${file.name})`);
                
                // 1. ì´ë¯¸ì§€ ë¡œë“œ (HEIC ë³€í™˜ í¬í•¨)
                const imgElement = await loadImage(file);
                
                // 2. ë°˜ë°˜ ìë¥´ê¸° ë° OCR
                await splitAndProcess(imgElement, file.name, i);
            }

            // 3. ì •ë ¬ (Natural Sort)
            processedPages.sort((a, b) => naturalCompare(a.name, b.name));

            updateProgress(100, 100, 'ë³€í™˜ ì™„ë£Œ! íŒŒì¼ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...');
            
            // 4. ê²°ê³¼ë¬¼ ìƒì„±
            await generateDownloads(wantPdf, wantZip);
            
            statusText.innerText = "ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";

        } catch (err) {
            console.error(err);
            alert('ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        } finally {
            startBtn.disabled = false;
        }
    });

    // === í•µì‹¬ ë¡œì§ í•¨ìˆ˜ë“¤ ===

    // ì´ë¯¸ì§€ ë¡œë“œ (HEIC ì§€ì›)
    async function loadImage(file) {
        let blob = file;
        // HEIC íŒŒì¼ì¸ ê²½ìš° ë³€í™˜
        if (file.name.toLowerCase().endsWith('.heic')) {
            statusText.innerText += ' (HEIC ë³€í™˜ ì¤‘...)';
            const converted = await heic2any({ blob: file, toType: "image/jpeg" });
            blob = Array.isArray(converted) ? converted[0] : converted;
        }

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.readAsDataURL(blob);
        });
    }

    // ì´ë¯¸ì§€ ë¶„í•  ë° OCR ì²˜ë¦¬
    async function splitAndProcess(img, originalName, index) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const w = img.width;
        const h = img.height;
        const halfW = Math.floor(w / 2);

        // ì™¼ìª½(L), ì˜¤ë¥¸ìª½(R) ìˆœì„œ
        const sides = [
            { id: 'L', sx: 0 },
            { id: 'R', sx: halfW }
        ];

        for (const side of sides) {
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • ë° ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
            canvas.width = halfW;
            canvas.height = h;
            ctx.drawImage(img, side.sx, 0, halfW, h, 0, 0, halfW, h);

            let finalName = "";
            let pageNum = null;

            // OCR ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
            if (chkOcr.checked) {
                // íŒŒì´ì¬ ë¡œì§: í•˜ë‹¨ 15% ì˜ì—­ í¬ë¡­
                const cropH = Math.floor(h * 0.15);
                const cropCanvas = document.createElement('canvas');
                cropCanvas.width = halfW;
                cropCanvas.height = cropH;
                const cropCtx = cropCanvas.getContext('2d');
                // í•˜ë‹¨ ë¶€ë¶„ë§Œ ë³µì‚¬
                cropCtx.drawImage(canvas, 0, h - cropH, halfW, cropH, 0, 0, halfW, cropH);

                // OCR ìˆ˜í–‰ (íƒ€ì„ì•„ì›ƒ ì ìš©)
                pageNum = await runSafeOCR(cropCanvas);
            }

            if (pageNum) {
                finalName = `${pageNum}.jpg`;
            } else {
                // ì¸ì‹ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì´ë¦„: íŒŒì¼ëª…_ì¸ë±ìŠ¤_L/R.jpg
                const cleanName = originalName.split('.')[0];
                finalName = `${cleanName}_${index}_${side.id}.jpg`;
            }

            // Blob ë³€í™˜
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.95));
            processedPages.push({ name: finalName, blob: blob, w: halfW, h: h });
        }
    }

    // ì•ˆì „í•œ OCR (íƒ€ì„ì•„ì›ƒ í¬í•¨)
    async function runSafeOCR(canvas) {
        // Tesseract.js ì‘ì—…
        const workerPromise = Tesseract.recognize(canvas, 'eng', {
            tessedit_char_whitelist: '0123456789' // ìˆ«ìë§Œ ì¸ì‹
        });

        // 3ì´ˆ íƒ€ì„ì•„ì›ƒ
        const timeoutPromise = new Promise((resolve) => {
            setTimeout(() => resolve({ data: { text: "" } }), 3000);
        });

        try {
            // ë‘˜ ì¤‘ ë¨¼ì € ëë‚˜ëŠ” ê²ƒ ì±„íƒ
            const { data: { text } } = await Promise.race([workerPromise, timeoutPromise]);
            const num = text.replace(/\D/g, ''); // ìˆ«ì ì´ì™¸ ì œê±°
            return num.length > 0 ? num : null;
        } catch (e) {
            console.log("OCR Error/Skipped");
            return null;
        }
    }

    // ê²°ê³¼ë¬¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
    async function generateDownloads(wantPdf, wantZip) {
        // 1. PDF ìƒì„±
        if (wantPdf) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            for (let i = 0; i < processedPages.length; i++) {
                const page = processedPages[i];
                const imgData = await blobToBase64(page.blob);
                
                // PDF í˜ì´ì§€ í¬ê¸°ë¥¼ ì´ë¯¸ì§€ ë¹„ìœ¨ì— ë§ì¶¤
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (page.h * pdfWidth) / page.w;

                if (i > 0) doc.addPage();
                doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            }
            
            createDownloadBtn('ğŸ“— PDF ë‹¤ìš´ë¡œë“œ', () => doc.save('split_book.pdf'));
        }

        // 2. ZIP ìƒì„±
        if (wantZip) {
            const zip = new JSZip();
            processedPages.forEach(p => {
                zip.file(p.name, p.blob);
            });
            
            const content = await zip.generateAsync({ type: "blob" });
            createDownloadBtn('ğŸ—‚ï¸ ZIP ë‹¤ìš´ë¡œë“œ', () => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = "split_images.zip";
                link.click();
            });
        }
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function updateProgress(curr, total, msg) {
        const percent = Math.round((curr / total) * 100);
        progressFill.style.width = `${percent}%`;
        statusText.innerText = msg;
    }

    function createDownloadBtn(label, onClick) {
        const btn = document.createElement('button');
        btn.className = 'btn-success';
        btn.innerText = label;
        btn.onclick = onClick;
        downloadArea.appendChild(btn);
    }

    function blobToBase64(blob) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        });
    }

    // ìì—° ì •ë ¬ (1, 2, 10, 11)
    function naturalCompare(a, b) {
        return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
    }
</script>

</body>
</html>
