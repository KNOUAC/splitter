<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNOUAC Book Splitter (Fixed)</title>
    <script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    
    <style>
        :root { --blue: #007bff; --red: #d9534f; --green: #28a745; }
        body { font-family: 'Suit', sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; color: #333; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .logo { font-family: 'Impact', sans-serif; font-size: 32px; color: #2c3e50; }
        .upload-box { border: 4px dashed #ccc; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { border-color: var(--blue); background-color: #f0f8ff; }
        .controls { margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; display: none; }
        .option-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px; align-items: center; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-primary { background-color: var(--red); }
        .btn-success { background-color: var(--green); }
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; height: 20px; background: #eee; border-radius: 10px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--blue); transition: 0.2s; }
        #status { font-size: 14px; margin-top: 5px; text-align: center; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">KNOUAC</div>
    <h2>ì±… ìŠ¤ìº” ì´ë¯¸ì§€ ë°˜ë°˜ ë¶„í• ê¸°</h2>
    <p>ì˜¤ë¥˜ ë°œìƒ ì‹œ 'í˜ì´ì§€ ë²ˆí˜¸ ì¸ì‹' ì²´í¬ë¥¼ í•´ì œí•˜ì„¸ìš”.</p>
</div>

<div class="upload-box" onclick="document.getElementById('fileInput').click()">
    <strong>ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</strong><br>
    (JPG, PNG, HEIC, BMP ì§€ì›)
    <input type="file" id="fileInput" multiple accept="image/*,.heic">
</div>

<div id="controls" class="controls">
    <div class="option-row">
        <label><input type="checkbox" id="optPdf" checked> PDF ìƒì„±</label>
        <label><input type="checkbox" id="optZip"> ZIP ìƒì„±</label>
    </div>
    <div class="option-row" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
        <label style="color: #d9534f; font-weight: bold;">
            <input type="checkbox" id="optOcr"> í˜ì´ì§€ ë²ˆí˜¸ ì¸ì‹ (ëŠë¦¼/ì˜¤ë¥˜ì‹œ í•´ì œ)
        </label>
    </div>
    <button id="startBtn" class="btn btn-primary">âŒ– ë³€í™˜ ì‹œì‘í•˜ê¸°</button>
</div>

<div id="progressContainer" class="progress-container">
    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    <div id="status">ì¤€ë¹„ ì¤‘...</div>
</div>

<div id="downloadArea" style="margin-top: 20px;"></div>

<script>
    const fileInput = document.getElementById('fileInput');
    const controls = document.getElementById('controls');
    const startBtn = document.getElementById('startBtn');
    const status = document.getElementById('status');
    const progressFill = document.getElementById('progressFill');
    const downloadArea = document.getElementById('downloadArea');
    const optOcr = document.getElementById('optOcr');

    let processedPages = [];

    fileInput.onchange = (e) => {
        if (e.target.files.length > 0) controls.style.display = 'block';
    };

    startBtn.onclick = async () => {
        const files = Array.from(fileInput.files);
        if (files.length === 0) return;

        downloadArea.innerHTML = '';
        processedPages = [];
        document.getElementById('progressContainer').style.display = 'block';
        startBtn.disabled = true;

        for (let i = 0; i < files.length; i++) {
            updateProgress(i, files.length, `${i + 1}ë²ˆì§¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...`);
            let file = files[i];

            try {
                // HEIC ë³€í™˜
                if (file.name.toLowerCase().endsWith('.heic')) {
                    const converted = await heic2any({ blob: file, toType: "image/jpeg" });
                    file = Array.isArray(converted) ? converted[0] : converted;
                }

                const img = await loadImage(file);
                await splitAndProcess(img, file.name, i);
            } catch (err) {
                console.error(err);
                status.innerText = `ì˜¤ë¥˜ ë°œìƒ: ${file.name} (ê±´ë„ˆëœ€)`;
            }
        }

        // íŒŒì¼ëª… ì •ë ¬
        processedPages.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));

        generateButtons();
        updateProgress(1, 1, "ë³€í™˜ ì™„ë£Œ!");
        startBtn.disabled = false;
    };

    function loadImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function splitAndProcess(img, originalName, index) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const w = img.width;
        const h = img.height;
        const halfW = Math.floor(w / 2);

        const sides = [
            { name: 'L', x: 0 },
            { name: 'R', x: halfW }
        ];

        for (const side of sides) {
            canvas.width = halfW;
            canvas.height = h;
            ctx.drawImage(img, side.x, 0, halfW, h, 0, 0, halfW, h);

            let finalName;
            
            // OCR ì˜µì…˜ì´ ì¼œì ¸ìˆì„ ë•Œë§Œ ì‹¤í–‰
            if (optOcr.checked) {
                const pageNum = await recognizePageNumber(canvas);
                finalName = pageNum ? `${pageNum}.jpg` : `${originalName.split('.')[0]}_${side.name}.jpg`;
            } else {
                // êº¼ì ¸ìˆìœ¼ë©´ ê¸°ë³¸ ì´ë¦„ ì‚¬ìš© (ë¹ ë¦„)
                finalName = `${originalName.split('.')[0]}_${index}_${side.name}.jpg`;
            }
            
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
            processedPages.push({ name: finalName, blob: blob, width: halfW, height: h });
        }
    }

    // íƒ€ì„ì•„ì›ƒ ê¸°ëŠ¥ì´ ì¶”ê°€ëœ OCR
    async function recognizePageNumber(canvas) {
        try {
            const tempCanvas = document.createElement('canvas');
            const tCtx = tempCanvas.getContext('2d');
            const cropH = canvas.height * 0.15;
            tempCanvas.width = canvas.width;
            tempCanvas.height = cropH;
            tCtx.drawImage(canvas, 0, canvas.height - cropH, canvas.width, cropH, 0, 0, canvas.width, cropH);

            // 5ì´ˆ ë‚´ ì‘ë‹µ ì—†ìœ¼ë©´ ê°•ì œ ì¢…ë£Œ (ë¬´í•œ ë¡œë”© ë°©ì§€)
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 5000));
            
            const ocrPromise = Tesseract.recognize(tempCanvas, 'eng', {
                tessedit_char_whitelist: '0123456789',
                logger: m => console.log(m) // ì½˜ì†”ì—ì„œ ì§„í–‰ìƒí™© í™•ì¸ ê°€ëŠ¥
            });

            const { data: { text } } = await Promise.race([ocrPromise, timeoutPromise]);
            return text.replace(/\D/g, '').slice(0, 4);
        } catch (e) { 
            console.log("OCR ê±´ë„ˆëœ€ (ì‹œê°„ì´ˆê³¼ ë˜ëŠ” ì˜¤ë¥˜)");
            return null; 
        }
    }

    function generateButtons() {
        if (document.getElementById('optPdf').checked) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-success';
            btn.innerText = 'ğŸ“— PDF ë‹¤ìš´ë¡œë“œ';
            btn.onclick = downloadPdf;
            downloadArea.appendChild(btn);
        }
        if (document.getElementById('optZip').checked) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-success';
            btn.innerText = 'ğŸ—‚ï¸ ZIP ë‹¤ìš´ë¡œë“œ';
            btn.onclick = downloadZip;
            downloadArea.appendChild(btn);
        }
    }

    async function downloadPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        for (let i = 0; i < processedPages.length; i++) {
            const page = processedPages[i];
            const imgData = await new Promise(res => {
                const reader = new FileReader();
                reader.onload = (e) => res(e.target.result);
                reader.readAsDataURL(page.blob);
            });
            const pdfW = doc.internal.pageSize.getWidth();
            const pdfH = (page.height * pdfW) / page.width;
            if (i > 0) doc.addPage();
            doc.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
        }
        doc.save('split_book.pdf');
    }

    async function downloadZip() {
        const zip = new JSZip();
        processedPages.forEach(p => zip.file(p.name, p.blob));
        const content = await zip.generateAsync({ type: "blob" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = "split_images.zip";
        link.click();
    }

    function updateProgress(curr, total, msg) {
        const percent = (curr / total) * 100;
        progressFill.style.width = percent + '%';
        status.innerText = msg;
    }
</script>

</body>
</html>
